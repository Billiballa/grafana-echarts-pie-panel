{"version":3,"sources":["../src/echarts_pie_ctrl.js"],"names":["MetricsPanelCtrl","_","echarts","EchartsPieCtrl","$scope","$injector","panelDefaults","EchartsOption","defaults","panel","events","on","onInitEditMode","bind","render","onDataReceived","dataList","data","dataChanged","IS_DATA_CHANGED","addEditorTab","scope","elem","attrs","ctrl","$panelContainer","find","option","echartsData","echartsDataSum","NaN","echartsLegend","height","row","isString","parseInt","replace","title","style","width","document","body","clientWidth","span","myChart","init","setDataOption","i","length","push","name","target","value","datapoints","setLegendOption","setDataSumOption","resize","clear","eval","setOption","renderingCompleted","templateUrl"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAASA,4B,kBAAAA,gB;;AACFC,a;;AACAC,mB;;;;;;;;;;;;;;;;;;;;;sCAGMC,c;;;AAET,wCAAYC,MAAZ,EAAoBC,SAApB,EAA+B;AAAA;;AAAA,gJACrBD,MADqB,EACbC,SADa;;AAG3B,wBAAMC,gBAAgB;AAClBC,uCAAe;AADG,qBAAtB;;AAIAN,sBAAEO,QAAF,CAAW,MAAKC,KAAhB,EAAuBH,aAAvB;;AAEA,0BAAKI,MAAL,CAAYC,EAAZ,CAAe,gBAAf,EAAiC,MAAKC,cAAL,CAAoBC,IAApB,OAAjC;AACA,0BAAKH,MAAL,CAAYC,EAAZ,CAAe,mBAAf,EAAoC,MAAKG,MAAL,CAAYD,IAAZ,OAApC;AACA,0BAAKH,MAAL,CAAYC,EAAZ,CAAe,eAAf,EAAgC,MAAKI,cAAL,CAAoBF,IAApB,OAAhC;AACA,0BAAKH,MAAL,CAAYC,EAAZ,CAAe,oBAAf,EAAqC,MAAKI,cAAL,CAAoBF,IAApB,OAArC;AAZ2B;AAa9B;;;;mDAEcG,Q,EAAU;AACrB,6BAAKC,IAAL,GAAYD,QAAZ;AACA,6BAAKE,WAAL;AACH;;;kDAEY;AACT,6BAAKC,eAAL,GAAuB,IAAvB;AACA,6BAAKL,MAAL;AACA,6BAAKK,eAAL,GAAuB,KAAvB;AACH;;;qDAEgB;AACb,6BAAKC,YAAL,CAAkB,SAAlB,EAA6B,sDAA7B,EAAqF,CAArF;AACH;;;yCAEIC,K,EAAOC,I,EAAMC,K,EAAOC,I,EAAM;AAC3B,4BAAMC,kBAAkBH,KAAKI,IAAL,CAAU,oBAAV,EAAgC,CAAhC,CAAxB;AACA,4BAAIC,SAAS,EAAb;AAAA,4BACIC,cAAc,EADlB;AAAA,4BAEIC,iBAAiBC,GAFrB;AAAA,4BAGIC,gBAAgB,EAHpB;;AAKAP,6BAAKL,eAAL,GAAuB,IAAvB;;AAEA;AACA,4BAAIa,SAASR,KAAKQ,MAAL,IAAevB,MAAMuB,MAArB,IAA+BR,KAAKS,GAAL,CAASD,MAArD;AACA,4BAAI/B,EAAEiC,QAAF,CAAWF,MAAX,CAAJ,EAAwB;AACpBA,qCAASG,SAASH,OAAOI,OAAP,CAAe,IAAf,EAAqB,EAArB,CAAT,EAAmC,EAAnC,CAAT;AACH;AACJJ,kCAAU,CAAV;AACAA,kCAAUR,KAAKf,KAAL,CAAW4B,KAAX,GAAmB,EAAnB,GAAwB,CAAlC;AACGZ,wCAAgBa,KAAhB,CAAsBN,MAAtB,GAA+BA,SAAS,IAAxC;;AAEA;AACA,4BAAIO,QAAQC,SAASC,IAAT,CAAcC,WAA1B;AACAH,gCAAQ,CAACA,QAAQ,MAAM,CAAf,IAAoBf,KAAKf,KAAL,CAAWkC,IAA/B,GAAsC,EAAtC,GAA2C,MAAM,CAAjD,GAAqD,IAAI,CAAzD,GAA6D,KAAK,CAA1E;AACAlB,wCAAgBa,KAAhB,CAAsBC,KAAtB,GAA8BA,QAAQ,IAAtC;;AAEA;AACA,4BAAIK,UAAU1C,QAAQ2C,IAAR,CAAapB,eAAb,EAA8B,MAA9B,CAAd;;AAEA;AACA,iCAASqB,aAAT,GAAyB;AACrBlB,0CAAc,EAAd;AACA,iCAAK,IAAImB,IAAI,CAAb,EAAgBA,IAAIvB,KAAKP,IAAL,CAAU+B,MAA9B,EAAsCD,GAAtC,EAA2C;AACvCnB,4CAAYqB,IAAZ,CAAiB;AACbC,0CAAM1B,KAAKP,IAAL,CAAU8B,CAAV,EAAaI,MADN;AAEbC,2CAAO5B,KAAKP,IAAL,CAAU8B,CAAV,EAAaM,UAAb,CAAwB7B,KAAKP,IAAL,CAAU8B,CAAV,EAAaM,UAAb,CAAwBL,MAAxB,GAAiC,CAAzD,EAA4D,CAA5D;AAFM,iCAAjB;AAIH;AACJ;;AAED,iCAASM,eAAT,GAA2B;AACvBvB,4CAAgB,EAAhB;AACA,iCAAK,IAAIgB,IAAI,CAAb,EAAgBA,IAAInB,YAAYoB,MAAhC,EAAwCD,GAAxC,EAA6C;AACzChB,8CAAckB,IAAd,CAAmBrB,YAAYmB,CAAZ,EAAeG,IAAlC;AACH;AACJ;;AAED,iCAASK,gBAAT,GAA4B;AACxB1B,6CAAiB,CAAjB;AACA,iCAAK,IAAIkB,IAAI,CAAb,EAAgBA,IAAInB,YAAYoB,MAAhC,EAAwCD,GAAxC,EAA6C;AACzClB,kDAAkBM,SAASP,YAAYmB,CAAZ,EAAeK,KAAxB,CAAlB;AACH;AACJ;;AAED,iCAAStC,MAAT,GAAkB;AACd,gCAAI,CAAC8B,OAAD,IAAU,CAACpB,KAAKP,IAApB,EAA0B;AACtB;AACH;AACD2B,oCAAQY,MAAR;AACA,gCAAIhC,KAAKL,eAAT,EAA0B;AACtByB,wCAAQa,KAAR;AACAX;AACAQ;AACAC;AACH;AACDG,iCAAKlC,KAAKf,KAAL,CAAWF,aAAhB;AACAqC,oCAAQe,SAAR,CAAkBhC,MAAlB;AACH;;AAED,6BAAKjB,MAAL,CAAYC,EAAZ,CAAe,QAAf,EAAyB,YAAY;AACjCG;AACAU,iCAAKoC,kBAAL;AACH,yBAHD;AAIH;;;;cAtG+B5D,gB;;;;AAyGpCG,2BAAe0D,WAAf,GAA6B,aAA7B","file":"echarts_pie_ctrl.js","sourcesContent":["import { MetricsPanelCtrl } from 'app/plugins/sdk';\r\nimport _ from 'lodash';\r\nimport echarts from './libs/echarts';\r\nimport './libs/dark';\r\n\r\nexport class EchartsPieCtrl extends MetricsPanelCtrl {\r\n\r\n    constructor($scope, $injector) {\r\n        super($scope, $injector);\r\n\r\n        const panelDefaults = {\r\n            EchartsOption: 'option = {}'\r\n        };\r\n\r\n        _.defaults(this.panel, panelDefaults);\r\n\r\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n        this.events.on('panel-initialized', this.render.bind(this));\r\n        this.events.on('data-received', this.onDataReceived.bind(this));\r\n        this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n    }\r\n\r\n    onDataReceived(dataList) {\r\n        this.data = dataList;\r\n        this.dataChanged();\r\n    }\r\n\r\n    dataChanged(){\r\n        this.IS_DATA_CHANGED = true;\r\n        this.render();\r\n        this.IS_DATA_CHANGED = false;\r\n    }\r\n\r\n    onInitEditMode() {\r\n        this.addEditorTab('Options', 'public/plugins/grafana-echarts-pie-panel/editor.html', 2);\r\n    }\r\n\r\n    link(scope, elem, attrs, ctrl) {\r\n        const $panelContainer = elem.find('.echarts_container')[0];\r\n        let option = {},\r\n            echartsData = [],\r\n            echartsDataSum = NaN,\r\n            echartsLegend = [];\r\n\r\n        ctrl.IS_DATA_CHANGED = true;\r\n\r\n        //init height\r\n        let height = ctrl.height || panel.height || ctrl.row.height;\r\n        if (_.isString(height)) {\r\n            height = parseInt(height.replace('px', ''), 10);\r\n        }\r\n\t    height -= 5;\r\n\t    height -= ctrl.panel.title ? 24 : 9;\r\n        $panelContainer.style.height = height + 'px';\r\n\r\n        //init width\r\n        let width = document.body.clientWidth;\r\n        width = (width - 5.6 * 2) * ctrl.panel.span / 12 - 5.6 * 2 - 1 * 2 - 10 * 2;\r\n        $panelContainer.style.width = width + 'px';\r\n\r\n        //init echarts\r\n        let myChart = echarts.init($panelContainer, 'dark');\r\n\r\n        //设置echarts option中的data,legend,dataSum变量,可在render的eval中使用\r\n        function setDataOption() {\r\n            echartsData = [];\r\n            for (let i = 0; i < ctrl.data.length; i++) {\r\n                echartsData.push({\r\n                    name: ctrl.data[i].target,\r\n                    value: ctrl.data[i].datapoints[ctrl.data[i].datapoints.length - 1][0]\r\n                });\r\n            }\r\n        }\r\n\r\n        function setLegendOption() {\r\n            echartsLegend = [];\r\n            for (let i = 0; i < echartsData.length; i++) {\r\n                echartsLegend.push(echartsData[i].name);\r\n            }\r\n        }\r\n\r\n        function setDataSumOption() {\r\n            echartsDataSum = 0;\r\n            for (let i = 0; i < echartsData.length; i++) {\r\n                echartsDataSum += parseInt(echartsData[i].value);\r\n            }\r\n        }\r\n\r\n        function render() {\r\n            if (!myChart||!ctrl.data) {\r\n                return;\r\n            }\r\n            myChart.resize();\r\n            if (ctrl.IS_DATA_CHANGED) {\r\n                myChart.clear();\r\n                setDataOption();\r\n                setLegendOption();\r\n                setDataSumOption();\r\n            }\r\n            eval(ctrl.panel.EchartsOption);\r\n            myChart.setOption(option);\r\n        }\r\n\r\n        this.events.on('render', function () {\r\n            render();\r\n            ctrl.renderingCompleted();\r\n        });\r\n    }\r\n}\r\n\r\nEchartsPieCtrl.templateUrl = 'module.html';\r\n"]}